# å¼‚å¸¸å¤„ç† Exception Handling

>C++ çš„å¼‚å¸¸å¤„ç†ï¼ˆ**Exception Handling**ï¼‰æ˜¯ç”¨æ¥å¤„ç†ç¨‹åºåœ¨**è¿è¡Œæ—¶**å‡ºç°çš„é”™è¯¯çš„ä¸€ç§æœºåˆ¶ã€‚
>
>å®ƒå¯ä»¥ä½¿ç¨‹åºåœ¨é‡åˆ°é”™è¯¯æ—¶ä¸ä¸­æ–­ï¼Œè€Œæ˜¯è·³è½¬åˆ°åˆé€‚çš„ä½ç½®è¿›è¡Œé”™è¯¯å¤„ç†ï¼Œä»è€Œæé«˜ç¨‹åºçš„å¥å£®æ€§å’Œå¯é æ€§ã€‚



##  ä¸€ã€åŸºæœ¬è¯­æ³•ç»“æ„

C++ ä½¿ç”¨ä»¥ä¸‹ä¸‰ä¸ªå…³é”®å­—æ¥å®ç°å¼‚å¸¸å¤„ç†ï¼š

- `try`ï¼šåŒ…å«å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„ä»£ç å—ã€‚
- `throw`ï¼šåœ¨**æ£€æµ‹**åˆ°é”™è¯¯æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚
- `catch`ï¼š**å¤„ç†**æŠ›å‡ºçš„å¼‚å¸¸ã€‚

### ğŸŒŸ ä¾‹å­ï¼š

```
cppå¤åˆ¶ç¼–è¾‘#include <iostream>
using namespace std;

int divide(int a, int b) {
    if (b == 0)
        throw "Division by zero!";  // æŠ›å‡ºä¸€ä¸ª const char* ç±»å‹å¼‚å¸¸
    return a / b;
}

int main() {
    try {
        int result = divide(10, 0);
        cout << "Result: " << result << endl;
    } catch (const char* msg) {
        cout << "Caught exception: " << msg << endl;
    }

    return 0;
}
```

## äºŒã€å¼‚å¸¸å¤„ç†æµç¨‹

å½“æ‰§è¡Œthrowè¯­å¥åï¼Œ

ä¸­æ–­å½“å‰å‡½æ•°çš„æ­£å¸¸æ‰§è¡Œæµç¨‹ï¼Œ

å¹¶å¼€å§‹å¯»æ‰¾åˆé€‚çš„**catchå—**æ¥å¤„ç†å¼‚å¸¸

### ğŸ§© 1. **å¼‚å¸¸æ£€æµ‹ï¼ˆæ£€æµ‹é”™è¯¯ï¼‰**

ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦æ£€æµ‹åˆ°æŸç§é”™è¯¯æƒ…å†µï¼ˆå¦‚éæ³•è¾“å…¥ã€é™¤ä»¥é›¶ã€æ–‡ä»¶æ‰“ä¸å¼€ï¼‰ï¼Œå°±æ‰§è¡Œï¼š

```cpp
throw å¼‚å¸¸å¯¹è±¡;
```

- å¼‚å¸¸å¯¹è±¡å¯ä»¥æ˜¯åŸºæœ¬ç±»å‹ã€ç±»å¯¹è±¡ã€å­—ç¬¦ä¸²ã€æ ‡å‡†å¼‚å¸¸ç­‰ã€‚
- ä¸€æ—¦æ‰§è¡Œ `throw`ï¼Œ**å½“å‰å‡½æ•°çš„åç»­ä»£ç ä¸ä¼šç»§ç»­æ‰§è¡Œ**ã€‚

------

### ğŸ§© 2. **æ ˆå±•å¼€ï¼ˆStack Unwindingï¼‰**

- `throw` åç¨‹åºä¼š**è·³å‡ºå½“å‰å‡½æ•°**ï¼Œæ²¿ç€è°ƒç”¨æ ˆ**ä¾æ¬¡å›é€€**ã€‚
- å¦‚æœå½“å‰å‡½æ•°æ²¡æœ‰å¤„ç†è¿™ä¸ªå¼‚å¸¸ï¼Œå®ƒä¼šé€€å‡ºå¹¶ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾è°è°ƒç”¨äº†å®ƒã€‚

------

### ğŸ§© 3. **å¯»æ‰¾åŒ¹é…çš„ catch å—**

- ç¨‹åºåœ¨è°ƒç”¨é“¾ä¸­**æŸ¥æ‰¾ç¬¬ä¸€ä¸ªä¸ `throw` ç±»å‹åŒ¹é…çš„ `catch` è¯­å¥å—**ï¼š

```cpp
try {
    // å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„ä»£ç 
} catch (const MyException& e) {
    // å¤„ç†å¼‚å¸¸
}
```

- ä¸€æ—¦åŒ¹é…ï¼Œå¼‚å¸¸è¢«æ•è·ï¼Œç¨‹åºè½¬åˆ° `catch` ä¸­æ‰§è¡Œã€‚
- å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„ `catch`ï¼Œæœ€ç»ˆä¼šè°ƒç”¨ï¼š

```cpp
std::terminate();  // ç¨‹åºç»ˆæ­¢è¿è¡Œ
```

------

### ğŸ§© 4. **å¤„ç†å¼‚å¸¸**

- åœ¨ `catch` å—ä¸­ï¼Œä½ å¯ä»¥ï¼š
  - æ‰“å°é”™è¯¯ä¿¡æ¯
  - è®°å½•æ—¥å¿—
  - æ¸…ç†èµ„æº
  - å°è¯•æ¢å¤
  - æˆ–è€…å†æ¬¡æŠ›å‡ºå¼‚å¸¸ï¼ˆ`throw;`ï¼‰

------

### ğŸ§© 5. **ç¨‹åºå¯èƒ½ç»§ç»­æ‰§è¡Œï¼ˆå¯é€‰ï¼‰**

- å¦‚æœå¼‚å¸¸å¤„ç†åï¼Œç¨‹åºä»å¯ç»§ç»­è¿è¡Œï¼Œå°±å¯ä»¥ä» `catch` å—ä¹‹åçš„è¯­å¥ç»§ç»­æ‰§è¡Œã€‚



## ä¸‰ã€throw å¯ä»¥æŠ›å‡ºçš„ç±»å‹

throw å¯ä»¥æŠ›å‡ºçš„ç±»å‹ï¼š

- åŸºæœ¬ç±»å‹ï¼ˆå¦‚ `int`, `double`, `const char*`ï¼‰
- æ ‡å‡†å¼‚å¸¸ç±»ï¼ˆå¦‚ `std::invalid_argument`ï¼‰
- è‡ªå®šä¹‰ç±»ï¼ˆç»§æ‰¿è‡ª `std::exception`ï¼‰



### æ ‡å‡†åº“å¼‚å¸¸ï¼ˆ`<stdexcept>`ï¼‰

C++ æ ‡å‡†åº“ä¸­åŒ…å«è®¸å¤šå¸¸ç”¨å¼‚å¸¸ç±»ï¼Œä¸»è¦åŒ…æ‹¬ï¼š

| å¼‚å¸¸ç±»å‹                | å«ä¹‰                   |
| ----------------------- | ---------------------- |
| `std::exception`        | æ‰€æœ‰æ ‡å‡†å¼‚å¸¸çš„åŸºç±»     |
| `std::runtime_error`    | è¿è¡Œæ—¶é”™è¯¯             |
| `std::logic_error`      | é€»è¾‘é”™è¯¯ï¼ˆå¦‚ç¼–ç¨‹é”™è¯¯ï¼‰ |
| `std::invalid_argument` | æ— æ•ˆå‚æ•°               |
| `std::out_of_range`     | è¶…å‡ºèŒƒå›´               |
| `std::overflow_error`   | æº¢å‡ºé”™è¯¯               |
| `std::underflow_error`  | ä¸‹æº¢é”™è¯¯               |

ä¸Šè¿°å¼‚å¸¸çš„ç»§æ‰¿å…³ç³»

```cpp
std::exception  //æ— æ³•ç¡®å®šå…·ä½“å¼‚å¸¸ç±»å‹æ—¶ä½¿ç”¨
â”œâ”€â”€ std::logic_error
â”‚   â”œâ”€â”€ std::invalid_argument
â”‚   â”œâ”€â”€ std::domain_error
â”‚   â””â”€â”€ ...
â””â”€â”€ std::runtime_error
    â”œâ”€â”€ std::range_error
    â”œâ”€â”€ std::overflow_error
    â””â”€â”€ ...
```

ç¤ºä¾‹ï¼š

```cpp
#include <stdexcept>
throw std::invalid_argument("Invalid input");
```

------



###  è‡ªå®šä¹‰å¼‚å¸¸ç±»

æ¨èç»§æ‰¿ `std::exception` å¹¶é‡å†™ `what()` æ–¹æ³•ï¼š

```cpp
#include <exception>
class MyException : public std::exception {//ç»§æ‰¿è‡ªstd::exception
public:
    const char* what() const noexcept override {
        return "My custom exception!";
    }
};
```



### åŸå°ä¸åŠ¨åœ°é‡æ–°æŠ›å‡º

å°†æ•è·åˆ°çš„å¼‚å¸¸åŸå°ä¸åŠ¨åœ°é‡æ–°æŠ›å‡º

```cpp
throw;
```

> [!WARNING]
>
> ```
> catch (const exception& e) {
>     throw e; // âŒ æ‹·è´æ„é€ ä¸€ä¸ªæ–°çš„å¼‚å¸¸å¯¹è±¡ â†’ å¯èƒ½å‘ç”Ÿå¯¹è±¡åˆ‡ç‰‡
> }
> 
> ```
>
> ä¸Šé¢è¿™ç§æ–¹å¼ä¸æ˜¯â€œåŸå°ä¸åŠ¨â€åœ°æŠ›å‡ºï¼Œè€Œæ˜¯**æŠ›å‡ºå¼‚å¸¸çš„æ‹·è´**ï¼Œå¯èƒ½å¯¼è‡´ï¼š
>
> - å¤šæ€å¤±æ•ˆï¼ˆå¯¹è±¡åˆ‡ç‰‡ï¼‰
> - ä¸¢å¤±åŸå§‹ç±»å‹ä¿¡æ¯æˆ–æ ˆè¿½è¸ªä¿¡æ¯



## å››ã€å¼‚å¸¸æ•è·æ–¹å¼

```cpp
#include <iostream>
#include <stdexcept>
using namespace std;

class DerivedException : public runtime_error {
public:
    DerivedException() : runtime_error("æ´¾ç”Ÿç±»å¼‚å¸¸") {}
    const char* what() const noexcept override {//é‡å†™what
        return "æˆ‘æ˜¯æ´¾ç”Ÿç±»!";
    }
};

int main() {
    try {
        throw DerivedException();
    } 
    // catch (runtime_error e) {
    //     cout << e.what() << endl; // æŒ‰å€¼æ•è·
    // }//è¾“å‡º"æ´¾ç”Ÿç±»å¼‚å¸¸"
    catch(const runtime_error& e){ // æŒ‰å¼•ç”¨æ•è·
        cout<<e.what()<<endl;  
    }//è¾“å‡º"æˆ‘æ˜¯æ´¾ç”Ÿç±»!"
    return 0;
}
```



### å¤šä¸ª catch å—ä¸ catch-all

#### å¤šä¸ª catchï¼š

```cpp
try {
    // ...
} catch (const std::invalid_argument& e) {
    cout << "Invalid argument: " << e.what();
} catch (const std::exception& e) {
    cout << "Standard exception: " << e.what();
}
```

#### æ•è·æ‰€æœ‰å¼‚å¸¸ï¼š

ç”¨çœç•¥å· `... `(3ç‚¹)

```cpp
catch (...) {
    cout << "Unknown exception caught!";
}
```



## äº”ã€å¼‚å¸¸å¤„ç†æ³¨æ„äº‹é¡¹

- å¼‚å¸¸æ˜¯**è¿è¡Œæ—¶é”™è¯¯**å¤„ç†æœºåˆ¶ï¼Œä¸åº”è¯¥ç”¨äºæ§åˆ¶ç¨‹åºæµç¨‹ã€‚
- æ„é€ å‡½æ•°æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œå¯¹è±¡ä¸ä¼šæ„é€ å®Œæˆï¼Œéœ€å°å¿ƒèµ„æºç®¡ç†ã€‚
- **RAII**ï¼ˆèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰å’Œæ™ºèƒ½æŒ‡é’ˆå¯å¸®åŠ©é˜²æ­¢å†…å­˜æ³„æ¼ã€‚
- å¦‚æœæ²¡æœ‰è¢« `catch`ï¼Œç¨‹åºä¼šè°ƒç”¨ `std::terminate()`ï¼Œç»ˆæ­¢è¿è¡Œã€‚

------

## å…­ã€ä½¿ç”¨åœºæ™¯

- æ–‡ä»¶æ‰“ä¸å¼€
- é™¤ä»¥é›¶
- æ•°ç»„è¶Šç•Œ
- ç½‘ç»œä¸­æ–­
- ç”¨æˆ·è¾“å…¥éæ³•

## ä¸ƒã€noexceptå…³é”®å­—

>`noexcept` æ˜¯ C++11 å¼•å…¥çš„ä¸€ä¸ªå…³é”®å­—ï¼Œç”¨æ¥**å£°æ˜ä¸€ä¸ªå‡½æ•°ä¸ä¼šæŠ›å‡ºå¼‚å¸¸**ã€‚å®ƒæ˜¯å¼‚å¸¸å®‰å…¨æ€§çš„ä¸€ä¸ªæ‰¿è¯ºï¼Œæœ‰åŠ©äºç¼–è¯‘å™¨ä¼˜åŒ–ä»£ç ï¼Œå¹¶æå‡ç¨‹åºçš„ç¨³å®šæ€§ã€‚

åŸºæœ¬ç”¨æ³•ï¼š

```cpp
void f() noexcept {
    // è¯¥å‡½æ•°ä¿è¯ä¸æŠ›å¼‚å¸¸
}
```

ç‰¹æ®Šæƒ…å†µï¼š

```cpp
void g() noexcept {
    throw std::runtime_error("error");  // ç¨‹åºä¼šè°ƒç”¨ std::terminate
}
```

è‹¥ä¸€ä¸ªå£°æ˜ä¸ºnoexceptçš„å‡½æ•°å®é™…æŠ›å‡ºäº†å¼‚å¸¸ï¼Œç¨‹åºä¼šç«‹å³è°ƒç”¨`std::terminate`